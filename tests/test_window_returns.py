import os
import pathlib
import sys

import pytest

ROOT = pathlib.Path(__file__).resolve().parents[1]
sys.path.append(str(ROOT))
os.environ.setdefault("TELEGRAM_TOKEN", "test-token")

from bot_econ_full_plus_rank_alerts import _metrics_from_chart


def _build_chart(timestamps, closes):
    return {"timestamp": timestamps, "indicators": {"adjclose": [{"adjclose": closes}]}}


BYMA_TIMESTAMPS = [
    1758290400,
    1758549600,
    1758636000,
    1758722400,
    1758808800,
    1758895200,
    1759154400,
    1759240800,
    1759327200,
    1759413600,
    1759500000,
    1759759200,
    1759845600,
    1759932000,
    1760018400,
    1760104800,
    1760364000,
    1760450400,
    1760536800,
    1760623200,
    1760709600,
    1760968800,
    1761055200,
    1761141600,
    1761228000,
    1761314400,
    1761573600,
    1761660000,
    1761746400,
    1761832800,
    1761919200,
    1762178400,
    1762264800,
    1762351200,
    1762437600,
    1762524000,
    1762783200,
    1762869600,
    1762956000,
    1763042400,
    1763128800,
    1763388000,
    1763474400,
    1763560800,
    1763647200,
    1763733600,
    1763992800,
    1764079200,
    1764165600,
    1764252000,
    1764338400,
    1764597600,
    1764684000,
    1764770400,
    1764856800,
    1764943200,
    1765202400,
    1765288800,
    1765375200,
    1765461600,
    1765548000,
    1765807200,
    1765893600,
]

BYMA_CLOSES = [
    142.44259643554688,
    162.5,
    175.5,
    182.75,
    176.75,
    182.75,
    184.0,
    178.5,
    175.25,
    179.5,
    180.25,
    180.25,
    175.75,
    175.0,
    192.0,
    192.0,
    197.25,
    188.25,
    181.0,
    179.75,
    181.75,
    178.75,
    182.25,
    183.0,
    184.0,
    191.5,
    224.0,
    239.5,
    271.5,
    279.0,
    305.0,
    305.0,
    317.75,
    322.75,
    312.25,
    298.0,
    293.25,
    284.5,
    290.25,
    284.5,
    292.5,
    291.5,
    293.25,
    286.0,
    285.25,
    276.25,
    276.25,
    286.0,
    292.75,
    298.25,
    299.5,
    300.0,
    301.25,
    303.75,
    299.75,
    301.5,
    301.5,
    302.0,
    304.25,
    303.0,
    300.0,
    295.25,
    294.75,
]

BMA_TIMESTAMPS = [
    1759327200,
    1759413600,
    1759500000,
    1759759200,
    1759845600,
    1759932000,
    1760018400,
    1760104800,
    1760364000,
    1760450400,
    1760536800,
    1760623200,
    1760709600,
    1760968800,
    1761055200,
    1761141600,
    1761228000,
    1761314400,
    1761573600,
    1761660000,
    1761746400,
    1761832800,
    1761919200,
    1762178400,
    1762264800,
    1762351200,
    1762437600,
    1762524000,
    1762783200,
    1762869600,
    1762956000,
    1763042400,
    1763128800,
    1763388000,
    1763474400,
    1763560800,
    1763647200,
    1763733600,
    1763992800,
    1764079200,
    1764165600,
    1764252000,
    1764338400,
    1764597600,
    1764684000,
    1764770400,
    1764856800,
    1764943200,
    1765202400,
    1765288800,
    1765375200,
    1765461600,
    1765548000,
    1765807200,
    1765893600,
    1765980000,
    1766066400,
    1766152800,
    1766412000,
    1766498400,
    1766584800,
    1766671200,
    1766757600,
]

BMA_CLOSES = [
    6212.7724609375,
    6380.41845703125,
    6434.65673828125,
    6523.41064453125,
    6528.34130859375,
    6681.19580078125,
    7346.849609375,
    7346.849609375,
    7553.9423828125,
    7327.12646484375,
    7529.2880859375,
    7667.349609375,
    8081.53466796875,
    8125.912109375,
    8416.8271484375,
    8771.8427734375,
    8914.8349609375,
    8885.25,
    11429.529296875,
    12169.14453125,
    12503.2490234375,
    12493.3408203125,
    13385.0146484375,
    13533.626953125,
    13385.0146484375,
    13167.0498046875,
    12978.80859375,
    12315.005859375,
    12374.451171875,
    12334.8212890625,
    12681.5830078125,
    12097.041015625,
    12275.3759765625,
    11740.37109375,
    11571.9443359375,
    11344.072265625,
    11542.2216796875,
    11056.7548828125,
    11056.7548828125,
    11680.9267578125,
    12625.4091796875,
    13013.73046875,
    12924.1181640625,
    12844.4619140625,
    12625.4091796875,
    13143.1708984375,
    13441.87890625,
    13182.9990234375,
    13182.9990234375,
    13003.7734375,
    13402.0517578125,
    13262.654296875,
    13093.3857421875,
    13282.568359375,
    13451.8359375,
    13402.0517578125,
    14258.3486328125,
    13889.94140625,
    13949.68359375,
    13660.931640625,
    13810.2861328125,
    13810.2861328125,
    13879.9853515625,
]


@pytest.mark.parametrize(
    "timestamps, closes",
    [
        (BYMA_TIMESTAMPS, BYMA_CLOSES),
        (BMA_TIMESTAMPS, BMA_CLOSES),
    ],
)
def test_yf_3m_window_close_to_close(timestamps, closes):
    res = _metrics_from_chart(_build_chart(timestamps, closes))
    assert res is not None
    last = closes[-1]
    base = closes[0]
    expected = (last / base - 1.0) * 100.0
    assert res["3m"] == pytest.approx(expected, rel=1e-6)

    avg = sum(closes) / len(closes)
    avg_ret = (last / avg - 1.0) * 100.0
    assert res["3m"] - avg_ret > 40.0
